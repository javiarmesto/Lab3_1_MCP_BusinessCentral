# üîß Gu√≠a de Configuraci√≥n del Conector en Copilot Studio

Esta gu√≠a te llevar√° paso a paso para crear y configurar el conector personalizado de Business Central en Microsoft Copilot Studio.

## üìã TL;DR

- **Tiempo estimado**: 30-45 minutos
- **Prerrequisitos**: Licencia Copilot Studio, servidor MCP desplegado
- **Resultado**: Conector operativo listo para usar en agentes conversacionales
- **M√©todo**: Importaci√≥n de definici√≥n OpenAPI + configuraci√≥n visual

---

## üéØ Prerrequisitos

### Licencias y Accesos Requeridos
- ‚úÖ **Microsoft Copilot Studio** con licencia activa
- ‚úÖ **Power Platform** - Entorno con permisos de administrador
- ‚úÖ **Servidor MCP desplegado** - URL operativa en Azure
- ‚úÖ **Credenciales de Business Central** - Configuradas en Azure App Service

### Verificaciones Previas
```http
# 1. Verificar que el servidor est√© operativo
GET https://mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net/health

# 2. Confirmar esquema OpenAPI disponible
GET https://mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net/openapi.json

# 3. Probar endpoint de ejemplo
GET https://mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net/customers?limit=3
```

---

## üöÄ Paso 1: Acceder a Copilot Studio

### 1.1 Navegar al Portal
1. Ir a **[Microsoft Copilot Studio](https://copilotstudio.microsoft.com/)**
2. Iniciar sesi√≥n con credenciales corporativas
3. Seleccionar el **entorno apropiado** (Desarrollo/Producci√≥n)

### 1.2 Verificar Permisos
- **System Administrator** o **System Customizer** en Power Platform
- **Copilot Studio User** como m√≠nimo
- **Environment Maker** para crear recursos

---

## üîå Paso 2: Crear el Conector Personalizado MCP

### 2.1 Proceso Oficial Microsoft para MCP

Seg√∫n la [documentaci√≥n oficial de Microsoft](https://learn.microsoft.com/en-us/microsoft-copilot-studio/agent-extend-action-mcp), el proceso para MCP es espec√≠fico:

1. **Crear un servidor MCP** ‚úÖ (Ya tienes esto desplegado)
2. **Crear conector personalizado MCP** basado en esquema YAML espec√≠fico  
3. **Consumir v√≠a Copilot Studio** agregando herramientas desde el conector MCP
4. **Publicar el conector** (opcional) para uso multi-tenant

### 2.2 Acceder a la Creaci√≥n de Conector MCP

**M√©todo Correcto Seg√∫n Microsoft**:
1. En Copilot Studio, ir a **"Agents"** en navegaci√≥n izquierda
2. Seleccionar tu agente de la lista
3. Ir a p√°gina **"Tools"** de tu agente  
4. Seleccionar **"Add a tool"**
5. Seleccionar **"New tool"**
6. Seleccionar **"Custom connector"** ‚Üí Te lleva a Power Apps
7. En Power Apps: **"New custom connector"** 
8. Seleccionar **"Import OpenAPI file"**

### 2.3 Importar Definici√≥n para MCP

**‚ö†Ô∏è Diferencia Cr√≠tica para MCP**: 
Microsoft requiere esquema YAML espec√≠fico compatible con Power Platform.

**Opci√≥n A: Usar Esquema Power Platform Compatible (Recomendado)**
1. Usar el archivo `business-central-power-platform.yaml` 
2. Seleccionar **"Upload file"** 
3. Subir el archivo YAML optimizado para Power Platform
4. Hacer clic en **"Import"**

**Opci√≥n B: Esquema MCP Streamable Puro (Avanzado)**
1. Usar el archivo `business-central-mcp-streamable.yaml`
2. ‚ö†Ô∏è **Nota**: Puede requerir ajustes adicionales para compatibilidad

**Si encuentras errores de validaci√≥n OpenAPI**:
- Usar `business-central-power-platform.yaml` que est√° optimizado para Power Platform
- Este esquema mantiene funcionalidad MCP pero es compatible con validaci√≥n de Microsoft

### 2.4 Configurar Informaci√≥n B√°sica MCP
- **Connector Name**: `Business Central MCP`
- **Description**: `Conector MCP para integrar Business Central v√≠a servidor MCP con transporte Streamable`
- **Host**: `mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net`
- **Base URL**: `/` (ra√≠z)

**‚ö†Ô∏è Diferencias Clave para MCP**:
- **Protocolo**: `x-ms-agentic-protocol: mcp-streamable-1.0`
- **Endpoint √∫nico**: `/mcp` (no m√∫ltiples endpoints REST)
- **Comunicaci√≥n**: JSON-RPC sobre HTTP POST
- **Herramientas**: Expuestas autom√°ticamente por el servidor MCP

---

## üîê Paso 3: Configurar Autenticaci√≥n MCP

### 3.1 Opciones de Autenticaci√≥n para MCP

**Para Desarrollo/Testing:**
- Seleccionar **"No authentication"**
- El servidor MCP maneja la autenticaci√≥n internamente
- √ötil para pruebas iniciales y desarrollo

**Para Producci√≥n (Recomendado):**
- Seleccionar **"API Key"**
- **Parameter label**: `API Key Business Central MCP`
- **Parameter name**: `X-API-Key`
- **Parameter location**: `Header`

### 3.2 Implementar Validaci√≥n API Key en Servidor MCP

Para producci√≥n, modifica tu servidor MCP para validar la API Key:

```python
# En bc_server/BusinessCentralMCP.py - Servidor MCP principal
import os
from typing import Optional

class BusinessCentralMCPServer:
    def __init__(self):
        self.api_key = os.getenv("API_KEY")
        
    async def validate_request(self, headers: dict) -> bool:
        """Validar API Key en requests MCP"""
        if not self.api_key:
            return True  # Sin validaci√≥n en desarrollo
            
        provided_key = headers.get("X-API-Key")
        return provided_key == self.api_key
    
    async def handle_call(self, request, headers: dict):
        """Manejar llamadas MCP con validaci√≥n"""
        if not await self.validate_request(headers):
            raise Exception("API Key inv√°lida o faltante")
        
        # Procesar solicitud MCP normalmente
        return await self.process_mcp_request(request)
```

**Configurar en Azure App Service**:
- Variable: `API_KEY`  
- Valor: `bc-mcp-secret-2025-v1` (usar clave segura)

---

## ‚úÖ Paso 4: Validar Herramientas MCP

### 4.1 Herramientas Detectadas Autom√°ticamente

Con MCP, las herramientas se detectan autom√°ticamente desde el servidor:

| Herramienta MCP | Descripci√≥n | Par√°metros |
|-----------------|-------------|------------|
| `get_customers` | Consultar clientes | `limit` (opcional) |
| `get_customer_details` | Detalle espec√≠fico cliente | `customer_id` |
| `create_customer` | Crear nuevo cliente | `displayName`, `email`, etc. |
| `get_items` | Cat√°logo productos | `limit` (opcional) |
| `get_sales_orders` | √ìrdenes de venta | `limit` (opcional) |
| `health_check` | Estado servidor | Ninguno |

### 4.2 Configuraci√≥n Autom√°tica vs Manual

**‚úÖ Ventaja MCP**: Las herramientas se configuran autom√°ticamente
- **Nombres**: Heredados del servidor MCP
- **Descripciones**: Definidas en el servidor
- **Par√°metros**: Validaci√≥n autom√°tica
- **Actualizaciones**: Din√°micas cuando cambia el servidor

**Personalizaci√≥n Opcional**:
- **Visibility**: Marcar herramientas principales como `Important`
- **Friendly Names**: Ajustar nombres para usuarios finales
- **Grouping**: Organizar por categor√≠as (Clientes, Productos, Ventas)

---

## üß™ Paso 5: Probar el Conector

### 5.1 Ejecutar Pruebas B√°sicas

1. Ir a la pesta√±a **"Test"**
2. Hacer clic en **"+ New connection"**
3. Si usas API Key, introducir la clave
4. Hacer clic en **"Create connection"**

### 5.2 Probar Operaciones

**Prueba 1: Health Check**
- Operaci√≥n: `healthCheck`
- Par√°metros: Ninguno
- Resultado esperado: `{"status": "ok"}`

**Prueba 2: Listar Clientes**
- Operaci√≥n: `getCustomers`
- Par√°metros: `limit = 3`
- Resultado esperado: Array con datos de clientes

**Prueba 3: Crear Cliente (Opcional)**
- Operaci√≥n: `createCustomer`
- Body: 
  ```json
  {
    "displayName": "Cliente Test Conector",
    "email": "test.conector@example.com"
  }
  ```

### 5.3 Validar Respuestas

‚úÖ **Conexi√≥n exitosa**: Status 200/201  
‚úÖ **Datos v√°lidos**: Estructura JSON correcta  
‚úÖ **Errores controlados**: Mensajes informativos en fallos  

---

## üé® Paso 6: Personalizar para Copilot

### 6.1 Configurar Pol√≠tica de Datos

1. Ir a **"Data"** > **"Data policies"**
2. Clasificar el conector seg√∫n sensibilidad:
   - **Business**: Para datos internos de la empresa
   - **Confidential**: Si incluye informaci√≥n sensible
   - **General**: Para datos no cr√≠ticos

### 6.2 Configurar Descripciones Sem√°nticas

Para mejorar la comprensi√≥n del AI, enriquecer descripciones:

**Para `getCustomers`:**
```
Busca y obtiene informaci√≥n de clientes registrados en Business Central. 
√ötil para consultas como "buscar cliente", "informaci√≥n de empresa", 
"datos de contacto". Permite limitar resultados para b√∫squedas eficientes.
```

**Para `createCustomer`:**
```
Registra un nuevo cliente en Business Central con datos b√°sicos. 
Requiere al menos nombre de la empresa. √ötil cuando el usuario dice 
"crear cliente", "registrar empresa", "dar de alta".
```

### 6.3 Configurar Triggers Sem√°nticos

Para cada operaci√≥n, agregar **palabras clave** que el AI reconocer√°:

| Operaci√≥n | Triggers Sugeridos |
|-----------|-------------------|
| `getCustomers` | buscar cliente, informaci√≥n empresa, contacto, cliente, empresa |
| `createCustomer` | crear cliente, registrar empresa, nuevo cliente, alta |
| `getCustomerById` | detalle cliente, informaci√≥n espec√≠fica, datos de |
| `getItems` | productos, art√≠culos, cat√°logo, inventario, stock |
| `getSalesOrders` | √≥rdenes, ventas, pedidos, facturaci√≥n |

---

## üöÄ Paso 7: Guardar y Publicar

### 7.1 Guardar Configuraci√≥n
1. Hacer clic en **"Save"** en la parte superior
2. Confirmar que no hay errores de validaci√≥n
3. Esperar confirmaci√≥n de guardado

### 7.2 Publicar el Conector
1. Hacer clic en **"Publish"**
2. Seleccionar **versi√≥n** (ej: `1.0.0`)
3. Agregar **notas de versi√≥n**:
   ```
   v1.0.0 - Conector inicial Business Central MCP
   - 6 operaciones principales implementadas
   - Integraci√≥n con datos reales de BC
   - Soporte para consultas y creaci√≥n
   ```
4. Confirmar publicaci√≥n

---

## ü§ñ Paso 8: Integrar con Agente

### 8.1 Crear Nuevo Agente
1. Ir a **"Copilots"** > **"Create"**
2. Elegir **"New copilot"**
3. Configurar:
   - **Name**: `Asistente Business Central`
   - **Description**: `Ayuda con consultas y gesti√≥n de datos de Business Central`
   - **Language**: `Spanish (Spain)`

### 8.2 Agregar el Conector
1. En el agente, ir a **"Actions"**
2. Hacer clic en **"+ Add action"**
3. Seleccionar **"Connector"**
4. Buscar `Business Central MCP`
5. Seleccionar las operaciones deseadas

### 8.3 Configurar Prompts de Sistema

```
Eres un asistente especializado en Microsoft Business Central. 

Puedes ayudar con:
- Buscar informaci√≥n de clientes y empresas
- Consultar el cat√°logo de productos
- Revisar √≥rdenes de venta
- Registrar nuevos clientes

Cuando el usuario pregunte sobre clientes, empresas o contactos, usa getCustomers.
Para consultas de productos o inventario, usa getItems.
Para informaci√≥n de ventas o pedidos, usa getSalesOrders.
Si necesitan registrar un cliente nuevo, usa createCustomer.

Siempre proporciona respuestas claras y estructuradas en espa√±ol.
```

---

## üîç Paso 9: Testing Final

### 9.1 Conversaciones de Prueba

**Prueba 1: Consulta de Cliente**
```
üë§ Usuario: "¬øPuedes buscar informaci√≥n de la empresa Fabrikam?"
ü§ñ Copilot: [Ejecuta getCustomers] "Encontr√© informaci√≥n de Fabrikam Inc..."
```

**Prueba 2: Cat√°logo de Productos**
```
üë§ Usuario: "¬øQu√© productos tenemos disponibles?"
ü§ñ Copilot: [Ejecuta getItems] "Aqu√≠ tienes nuestro cat√°logo..."
```

**Prueba 3: Crear Cliente**
```
üë§ Usuario: "Necesito registrar una nueva empresa llamada TechCorp"
ü§ñ Copilot: [Solicita datos] "¬øPuedes proporcionarme email y direcci√≥n?"
```

### 9.2 Validar Integraci√≥n Completa

‚úÖ **Conexiones funcionando**: Sin errores de conectividad  
‚úÖ **Datos correctos**: Informaci√≥n real de Business Central  
‚úÖ **Flujo natural**: Conversaciones fluidas  
‚úÖ **Manejo de errores**: Respuestas apropiadas en fallos  

---

## üéØ Pr√≥ximos Pasos

### Mejoras Inmediatas
- [ ] **Configurar m√°s operaciones** (actualizar, eliminar)
- [ ] **Refinar prompts** para mejores respuestas
- [ ] **Agregar validaciones** de entrada
- [ ] **Implementar logging** detallado

### Integraci√≥n Avanzada
- [ ] **Power Automate flows** para automatizaciones
- [ ] **Power Apps integrations** para interfaces visuales
- [ ] **Teams integration** para colaboraci√≥n
- [ ] **SharePoint connectors** para documentaci√≥n

### Monitorizaci√≥n
- [ ] **Usage analytics** en Power Platform
- [ ] **Performance monitoring** del servidor MCP
- [ ] **Error tracking** y alertas
- [ ] **User feedback** y mejoras

---

## üÜò Troubleshooting

### Problemas Comunes

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| `Connection timeout` | Servidor no responde | Verificar URL y estado Azure App Service |
| `401 Unauthorized` | API Key incorrecta | Revisar configuraci√≥n de autenticaci√≥n |
| `404 Not Found` | Endpoint incorrecto | Validar URLs en definici√≥n YAML |
| `500 Internal Error` | Error servidor MCP | Revisar logs Azure y variables entorno |
| **`Parsing error: Operation can have only one body parameter`** | **Esquema YAML incompatible** | **Usar `business-central-power-platform.yaml`** |
| **`ValidationError: The input OpenAPI file is not valid`** | **Formato OpenAPI incorrecto** | **Usar esquema optimizado para Power Platform** |

### Errores Espec√≠ficos de MCP

**Error: "Operation can have only one body parameter"**
- **Causa**: El esquema YAML tiene m√∫ltiples par√°metros de cuerpo
- **Soluci√≥n**: Usar `business-central-power-platform.yaml` que est√° optimizado para Power Platform
- **Detalle**: OpenAPI 2.0 solo permite un par√°metro body por operaci√≥n

**Error: "The input OpenAPI file is not valid for OpenAPI specification"**
- **Causa**: Extensiones MCP no reconocidas por validador Power Platform
- **Soluci√≥n**: El esquema `business-central-power-platform.yaml` mantiene funcionalidad MCP pero es compatible
- **Alternativa**: Eliminar extensiones espec√≠ficas MCP del YAML original

### Logs y Diagn√≥stico

**Logs del Conector:**
1. Copilot Studio > Connectors > Business Central MCP
2. Pesta√±a "Analytics"
3. Revisar llamadas recientes y errores

**Logs del Servidor:**
```bash
az webapp log tail --name mcp-bc-javi --resource-group rg-mcp-bc
```

**Validaci√≥n Manual:**
```bash
# Probar conexi√≥n directa
curl -X GET "https://mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net/health"

# Con API Key
curl -X GET "https://mcp-bc-javi-chb7bue4evbkeyb0.westeurope-01.azurewebsites.net/customers?limit=3" \
  -H "X-API-Key: your-secret-key"
```

---

## üìö Referencias

| Recurso | URL |
|---------|-----|
| Copilot Studio Connectors | https://learn.microsoft.com/en-us/microsoft-copilot-studio/advanced-custom-connectors |
| Power Platform Connectors | https://learn.microsoft.com/en-us/connectors/custom-connectors/ |
| OpenAPI 3.0 Specification | https://swagger.io/specification/ |
| Power Platform Admin Center | https://admin.powerplatform.microsoft.com/ |

---

**üéâ ¬°Conector configurado exitosamente!** 

Tu agente conversacional ya puede hablar directamente con Business Central. ¬°Es hora de crear conversaciones inteligentes! üöÄ
